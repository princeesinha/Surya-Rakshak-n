<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SURYA RAKSHAK - SECURE 3D COMMAND CENTER</title>

    <!-- Google Sign-In -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            /* UNIFIED THEME */
            --bg: #05080a;
            --glass: rgba(15, 25, 35, 0.8);
            --border: rgba(0, 212, 255, 0.3);
            --accent: #00d4ff;
            --alert: #ff4757;
            --success: #2ed573;
            --warning: #ffa502;
            --glow: 0 0 20px rgba(0, 212, 255, 0.2);
            --primary: #4285F4;
            --bg-login-gradient: linear-gradient(to right, #24243e, #302b63, #0f0c29);
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            color: white;
            margin: 0;
            min-height: 100vh;
            overflow-x: hidden;
            transition: background 1s ease;
            perspective: 1200px;
        }

        /* ========== LOGIN STATE ========== */
        body.mode-login {
            background: var(--bg-login-gradient);
            display: flex;
            justify-content: center;
            align-items: center;
            perspective: 1000px;
        }

        #login-view {
            width: 350px;
            height: 450px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.1s ease;
            z-index: 10;
        }

        .login-card {
            width: 100%; height: 100%;
            background: var(--glass);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            border-radius: 20px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            transform: translateZ(20px);
            text-align: center;
        }

        .card-content h1 { transform: translateZ(50px); font-size: 2.5rem; margin-bottom: 10px; letter-spacing: 3px; color: var(--accent); }
        .card-content p { transform: translateZ(30px); margin-bottom: 40px; opacity: 0.8; }

        .google-btn-wrapper {
            transform: translateZ(60px);
            background: white; padding: 5px; border-radius: 4px;
            box-shadow: 0 10px 25px rgba(66, 133, 244, 0.4);
            transition: transform 0.3s ease;
        }
        .google-btn-wrapper:hover { transform: translateZ(80px) scale(1.05); }

        /* Floating decorative circles */
        .circle { position: fixed; border-radius: 50%; background: linear-gradient(135deg, var(--primary), #d92d7b); z-index: -1; opacity: 0.6; }
        .c1 { width: 200px; height: 200px; top: -50px; left: -50px; animation: float 6s ease-in-out infinite; }
        .c2 { width: 150px; height: 150px; bottom: -30px; right: -30px; animation: float 8s ease-in-out infinite reverse; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }

        /* ========== DASHBOARD STATE ========== */
        body.mode-dashboard {
            background: radial-gradient(circle at center, #1a1f2c 0%, #0b0e14 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            overflow-y: auto;
        }

        #dashboard-view { display: none; width: 100%; max-width: 1100px; animation: fadeIn 1.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        #alertOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, rgba(255, 71, 87, 0.2) 0%, transparent 70%);
            display: none; pointer-events: none; z-index: 0;
        }
        .alert-active #alertOverlay { display: block; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 0.3; } 50% { opacity: 1; } 100% { opacity: 0.3; } }

        /* Unified Grid & Cards */
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; margin-top: 20px; }
        .card, .glass-card {
            background: var(--glass);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 24px;
            transition: transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
            transform-style: preserve-3d;
            box-shadow: var(--glow);
            text-align: center;
        }
        .card:hover, .glass-card:hover {
            transform: translateY(-5px) rotateX(4deg) rotateY(1deg);
            border-color: var(--accent);
        }

        .status-bar { grid-column: 1 / -1; font-weight: bold; padding: 15px; border-radius: 10px; border: 1px solid var(--border); text-align: center; letter-spacing: 3px; }
        .alert-active .status-bar { background: var(--alert); box-shadow: 0 0 20px var(--alert); border-color: transparent; }

        .advice-section { grid-column: 1 / -1; text-align: left; background: rgba(0, 212, 255, 0.05); border-left: 4px solid var(--accent); }
        .crit { color: var(--alert); font-weight: bold; }

        .user-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        #userInfo { font-size: 0.9rem; color: var(--accent); display: flex; align-items: center; gap: 10px;}
        #userAvatar { width: 35px; height: 35px; border-radius: 50%; border: 2px solid var(--accent); }

        /* Gauges */
        .gauge-container { position: relative; width: 140px; height: 140px; margin: 10px auto; }
        .gauge-svg { transform: rotate(-90deg); width: 140px; height: 140px; }
        .gauge-bg { fill: none; stroke: #222; stroke-width: 10; }
        .gauge-cap { fill: none; stroke-width: 10; stroke-linecap: round; transition: stroke-dashoffset 0.8s ease; }
        .gauge-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.8rem; font-weight: 800; }

        /* Buttons */
        .connect-btn, .ctrl-btn {
            background: var(--accent); color: #000; border: none; padding: 15px 40px;
            border-radius: 50px; font-weight: 900; cursor: pointer; transition: 0.3s;
            box-shadow: 0 0 30px rgba(0, 212, 255, 0.4);
        }
        .connect-btn:hover, .ctrl-btn:hover { transform: scale(1.05); filter: brightness(1.2); }
        .ctrl-btn { width: 45%; padding: 12px; border-radius: 10px; }
        .btn-on { background: var(--success); } 
        .btn-off { background: var(--alert); color: white; }

        .chart-wrapper { height: 250px; margin-top: 10px; }
    </style>
</head>
<body id="mainBody" class="mode-login">

    <!-- Decorative circles for login -->
    <div class="circle c1" id="decor1"></div>
    <div class="circle c2" id="decor2"></div>

    <!-- ========== LOGIN VIEW ========== -->
    <div id="login-view">
        <div class="login-card">
            <div class="card-content">
                <h1 id="loginTitle">SURYA RAKSHAK</h1>
                <p id="loginSubtitle">Access Secure Command Center</p>
                
                <div class="google-btn-wrapper">
                    <div id="g_id_onload"
                        data-client_id="614806307442-1thpblb9tkq2j5rnm6ihipaiku7gpbdg.apps.googleusercontent.com"
                        data-context="signin"
                        data-ux_mode="popup"
                        data-callback="handleCredentialResponse"
                        data-auto_prompt="false">
                    </div>

                    <div class="g_id_signin"
                        data-type="standard"
                        data-shape="rectangular"
                        data-theme="outline"
                        data-text="signin_with"
                        data-size="large"
                        data-logo_alignment="left">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== DASHBOARD VIEW ========== -->
    <div id="alertOverlay"></div>

    <div id="dashboard-view">
        <div class="user-header">
            <h2>SURYA RAKSHAK - COMMAND CENTER</h2>
            <div id="userInfo">
                <span id="userName">Not Connected</span>
                <img id="userAvatar" src="" style="display:none">
                <button onclick="logout()" style="background:none; border:1px solid #555; color:#aaa; cursor:pointer; padding:5px 10px; border-radius:5px; margin-left:10px;">Logout</button>
            </div>
        </div>

        <button id="btConnect" class="connect-btn">üì° CONNECT HARDWARE (SERIAL/BLUETOOTH)</button>

        <div class="grid">
            <div class="card status-bar" id="statusBox">SYSTEM OFFLINE</div>

            <div class="card advice-section">
                <h3>üí° SYSTEM ADVICE</h3>
                <ul class="advice-list" id="adviceList">
                    <li>Connect hardware to begin monitoring environment data.</li>
                </ul>
            </div>

            <div class="card">
                <span>TEMPERATURE (¬∞C)</span>
                <div class="gauge-container">
                    <svg class="gauge-svg"><circle class="gauge-bg" cx="70" cy="70" r="60"></circle>
                    <circle id="tCircle" class="gauge-cap" cx="70" cy="70" r="60" style="stroke:#ff4757; stroke-dasharray: 377; stroke-dashoffset: 377;"></circle></svg>
                    <div class="gauge-text" id="tVal">--</div>
                </div>
            </div>

            <div class="card">
                <span>HUMIDITY (%)</span>
                <div class="gauge-container">
                    <svg class="gauge-svg"><circle class="gauge-bg" cx="70" cy="70" r="60"></circle>
                    <circle id="hCircle" class="gauge-cap" cx="70" cy="70" r="60" style="stroke:#00d4ff; stroke-dasharray: 377; stroke-dashoffset: 377;"></circle></svg>
                    <div class="gauge-text" id="hVal">--</div>
                </div>
            </div>

            <div class="card">
                <span>UV INDEX</span>
                <div class="gauge-container">
                    <svg class="gauge-svg"><circle class="gauge-bg" cx="70" cy="70" r="60"></circle>
                    <circle id="uCircle" class="gauge-cap" cx="70" cy="70" r="60" style="stroke:#ffa502; stroke-dasharray: 377; stroke-dashoffset: 377;"></circle></svg>
                    <div class="gauge-text" id="uVal">--</div>
                </div>
            </div>

            <div class="card" style="grid-column: span 2;">
                <span>LIVE EXPOSURE TRENDS</span>
                <div class="chart-wrapper">
                    <canvas id="liveChart"></canvas>
                </div>
            </div>

            <div class="card">
                <span>MANUAL OVERRIDE</span>
                <div style="margin-top:20px; display:flex; justify-content: space-around;">
                    <button class="ctrl-btn btn-on" id="btnLedOn">LED ON</button>
                    <button class="ctrl-btn btn-off" id="btnLedOff">LED OFF</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== LOGIN & 3D ANIMATION ==========
        const loginCard = document.getElementById('login-view');
        const body = document.getElementById('mainBody');

        // 3D tilt effect on mouse move
        body.addEventListener('mousemove', (e) => {
            if (!body.classList.contains('mode-login')) return;
            let xAxis = (window.innerWidth / 2 - e.pageX) / 25;
            let yAxis = (window.innerHeight / 2 - e.pageY) / 25;
            loginCard.style.transform = `rotateY(${xAxis}deg) rotateX(${yAxis}deg)`;
        });

        // Google Auth
        function handleCredentialResponse(response) {
            const responsePayload = decodeJwtResponse(response.credential);
            transitionToDashboard(responsePayload);
        }

        function decodeJwtResponse(token) {
            var base64Url = token.split('.')[1];
            var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }

        function transitionToDashboard(user) {
            document.getElementById('loginTitle').innerText = "Access Granted";
            document.getElementById('loginSubtitle').innerText = "Loading Modules...";
            
            setTimeout(() => {
                body.classList.remove('mode-login');
                body.classList.add('mode-dashboard');
                
                document.getElementById('login-view').style.display = 'none';
                document.getElementById('decor1').style.display = 'none';
                document.getElementById('decor2').style.display = 'none';
                document.getElementById('dashboard-view').style.display = 'block';

                document.getElementById('userName').innerText = user.name;
                const avatar = document.getElementById('userAvatar');
                avatar.src = user.picture;
                avatar.style.display = 'block';
            }, 1000);
        }

        function logout() {
            location.reload();
        }

        // ========== HARDWARE & SERIAL LOGIC ==========
        let port, chart;
        const LIMITS = { temp: 35, hum: 70, uv: 6.0 };

        // Chart.js initialization
        const ctx = document.getElementById('liveChart').getContext('2d');
        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: 'UV', borderColor: '#ffa502', data: [], tension: 0.4, borderWidth: 2 },
                    { label: 'Temp', borderColor: '#ff4757', data: [], tension: 0.4, borderWidth: 2 }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });

        document.getElementById('btConnect').onclick = async () => {
            if ("serial" in navigator) {
                try {
                    port = await navigator.serial.requestPort();
                    await port.open({ baudRate: 9600 });
                    document.getElementById('statusBox').innerText = "CONNECTION SECURE - RECEIVING DATA";
                    document.getElementById('statusBox').style.borderColor = "#2ed573";
                    document.getElementById('btConnect').style.display = 'none';
                    readLoop();
                } catch (err) { 
                    console.error("Connection failed", err);
                    alert("Failed to connect. Make sure you select the correct port.");
                }
            } else {
                alert("Web Serial API not supported in this browser. Use Chrome or Edge.");
            }
        };

        // Manual override buttons
        document.getElementById('btnLedOn').onclick = () => sendCmd('1');
        document.getElementById('btnLedOff').onclick = () => sendCmd('0');

        async function sendCmd(c) {
            if (port && port.writable) {
                const writer = port.writable.getWriter();
                const encoder = new TextEncoder();
                await writer.write(encoder.encode(c));
                writer.releaseLock();
                console.log("Sent command:", c);
            }
        }

        async function readLoop() {
            const decoder = new TextDecoderStream();
            const inputDone = port.readable.pipeTo(decoder.writable);
            const inputStream = decoder.readable;
            const reader = inputStream.getReader();
            
            let buffer = "";
            
            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                
                buffer += value;
                let lines = buffer.split('\n');
                buffer = lines.pop();
                
                for (let line of lines) {
                    if (line.trim()) updateUI(line.trim());
                }
            }
        }

        function updateUI(data) {
            let p = data.split(',');
            if (p.length < 5) return;
            
            let temp = Math.round(parseFloat(p[0]));
            let hum = Math.round(parseFloat(p[1]));
            let uv = parseFloat(p[4]).toFixed(1);

            // Update gauges
            updateGauge('tVal', 'tCircle', temp, 50);
            updateGauge('hVal', 'hCircle', hum, 100);
            updateGauge('uVal', 'uCircle', uv, 11);

            // Update chart
            const time = new Date().toLocaleTimeString().split(' ')[0];
            chart.data.labels.push(time);
            chart.data.datasets[0].data.push(uv);
            chart.data.datasets[1].data.push(temp);
            if(chart.data.labels.length > 10) { 
                chart.data.labels.shift(); 
                chart.data.datasets[0].data.shift(); 
                chart.data.datasets[1].data.shift(); 
            }
            chart.update('none');

            // Alerts & advice
            let advice = [];
            if (temp > LIMITS.temp) advice.push(`<li><b class="crit">HIGH TEMP (${temp}¬∞C) - Check Cooling</b></li>`);
            if (hum > LIMITS.hum) advice.push(`<li><b class="crit">HIGH HUMIDITY (${hum}%) - Dehumidify</b></li>`);
            if (uv > LIMITS.uv) advice.push(`<li><b class="crit">HIGH UV (${uv}) - Seek Shade</b></li>`);
            
            const box = document.getElementById('statusBox');
            if (advice.length > 0) {
                body.classList.add('alert-active');
                box.innerText = "‚ö†Ô∏è CRITICAL STATUS ‚ö†Ô∏è";
                document.getElementById('adviceList').innerHTML = advice.join('');
            } else {
                body.classList.remove('alert-active');
                box.innerText = "SYSTEM NORMAL";
                document.getElementById('adviceList').innerHTML = "<li>Safe levels detected. System nominal.</li>";
            }
        }

        function updateGauge(textId, circleId, val, max) {
            const circle = document.getElementById(circleId);
            const circumference = 377;
            let displayVal = val > max ? max : (val < 0 ? 0 : val);
            const offset = circumference - (displayVal / max) * circumference;
            circle.style.strokeDashoffset = offset;
            document.getElementById(textId).innerText = val;
        }
    </script>
</body>
</html>